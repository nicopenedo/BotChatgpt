<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/dashboard.css}" href="/css/dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>
  </head>
  <body data-default-symbol="[[${defaultSymbol}]]" data-default-interval="[[${defaultInterval}]]"
        data-default-from="[[${defaultFrom}]]" data-default-to="[[${defaultTo}]]">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand">Trading Reports</span>
      </div>
    </nav>
    <main class="container-fluid mt-3">
      <section class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-2">
              <label class="form-label">Symbol</label>
              <select id="symbol" class="form-select">
                <option th:each="symbol : ${symbols}" th:value="${symbol}" th:text="${symbol}"></option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Interval</label>
              <select id="interval" class="form-select">
                <option th:each="interval : ${intervals}" th:value="${interval}" th:text="${interval}"></option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">From</label>
              <input type="datetime-local" id="from" class="form-control" />
            </div>
            <div class="col-md-3">
              <label class="form-label">To</label>
              <input type="datetime-local" id="to" class="form-control" />
            </div>
            <div class="col-md-2 d-grid">
              <button id="applyFilters" class="btn btn-primary">Apply</button>
            </div>
          </div>
          <div class="row mt-3 g-3">
            <div class="col-md-2">
              <label class="form-label">Side</label>
              <select id="side" class="form-select">
                <option value="">All</option>
                <option value="BUY">BUY</option>
                <option value="SELL">SELL</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Position Status</label>
              <select id="status" class="form-select">
                <option value="">All</option>
                <option value="OPENING">Opening</option>
                <option value="OPEN">Open</option>
                <option value="CLOSED">Closed</option>
              </select>
            </div>
            <div class="col-md-8 text-end toggles">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="toggleVwap" checked />
                <label class="form-check-label" for="toggleVwap">VWAP</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="toggleAnchoredVwap" />
                <label class="form-check-label" for="toggleAnchoredVwap">Anchored VWAP</label>
              </div>
              <input type="datetime-local" id="anchorTs" class="form-control d-inline w-auto ms-2" />
              <div class="form-check form-check-inline ms-3">
                <input class="form-check-input" type="checkbox" id="toggleAtr" checked />
                <label class="form-check-label" for="toggleAtr">ATR Bands</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="toggleSupertrend" />
                <label class="form-check-label" for="toggleSupertrend">Supertrend</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="toggleVolume" checked />
                <label class="form-check-label" for="toggleVolume">Volume</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="toggleAdvancedMarkers" checked />
                <label class="form-check-label" for="toggleAdvancedMarkers">Advanced markers</label>
              </div>
            </div>
          </div>
          <div class="row g-3 mt-3 status-row">
            <div class="col-lg-3 col-sm-6">
              <div class="status-card">
                <div class="status-title">Allocator</div>
                <span class="status-pill" id="allocatorBadge">--</span>
                <div class="status-subtext" id="allocatorNote">--</div>
              </div>
            </div>
            <div class="col-lg-3 col-sm-6">
              <div class="status-card">
                <div class="status-title">Drift</div>
                <span class="status-pill" id="driftBadge">--</span>
                <div class="status-subtext" id="driftNote">--</div>
              </div>
            </div>
            <div class="col-lg-3 col-sm-6">
              <div class="status-card">
                <div class="status-title">Health</div>
                <span class="status-pill" id="healthBadge">--</span>
                <div class="status-subtext" id="healthNote">--</div>
              </div>
            </div>
            <div class="col-lg-3 col-sm-6">
              <div class="status-card">
                <div class="status-title">Trading Mode</div>
                <span class="status-pill" id="modeBadge">--</span>
                <div class="status-subtext" id="modeNote">--</div>
              </div>
            </div>
            <div class="col-lg-3 col-sm-6">
              <div class="status-card">
                <div class="status-title">CVaR</div>
                <span class="status-pill" id="varBadge">--</span>
                <div class="status-subtext" id="varNote">--</div>
              </div>
            </div>
          </div>
          <div id="anomalyBanner" class="alert anomaly-banner d-none mt-3" role="alert">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
              <div>
                <span id="anomalySeverity" class="badge anomaly-badge">--</span>
                <strong id="anomalyTitle" class="ms-2">Anomalía operativa</strong>
                <div id="anomalyCause" class="text-muted small mt-1"></div>
                <div id="anomalyExpires" class="text-muted small"></div>
              </div>
              <div class="sparkline-wrapper">
                <canvas id="anomalySparkline" height="60"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="row g-3">
        <div class="col-lg-9">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Price</span>
              <div>
                <button class="btn btn-outline-secondary btn-sm" id="exportChartPng">Export PNG</button>
              </div>
            </div>
            <div class="card-body">
              <div class="regime-ribbon" id="regimeRibbon"></div>
              <div class="regime-legend" id="regimeLegend">--</div>
              <canvas id="priceChart" height="320"></canvas>
              <canvas id="volumeChart" class="mt-3" height="120"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="card shadow-sm mb-3">
            <div class="card-header">KPIs</div>
            <div class="card-body">
              <div class="row g-3" id="kpiContainer"></div>
            </div>
          </div>
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Heatmap</span>
              <button class="btn btn-outline-secondary btn-sm" id="exportHeatmapCsv">Export CSV</button>
            </div>
            <div class="card-body">
              <div id="heatmap"></div>
            </div>
          </div>
          <div class="card shadow-sm mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>CVaR Snapshots</span>
              <small class="text-muted" id="varSnapshotMeta">--</small>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm" id="varSnapshots">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>CVaR</th>
                      <th>Size</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="row g-3 mt-3">
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header">Equity Curve</div>
            <div class="card-body">
              <canvas id="equityChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm">
            <div class="card-header">Drawdown</div>
            <div class="card-body">
              <canvas id="drawdownChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between">
          <span>Trades</span>
          <div>
            <button class="btn btn-outline-secondary btn-sm" id="exportTradesCsv">Export CSV</button>
            <button class="btn btn-outline-secondary btn-sm" id="exportTradesJson">Export JSON</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped" id="tradesTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Price</th>
                  <th>Qty</th>
                  <th>Fee</th>
                  <th>PnL</th>
                  <th>PnL (R)</th>
                  <th>Slippage (bps)</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>TCA · Slippage</span>
          <span class="badge rounded-pill bg-secondary" id="tcaSamples">0 samples</span>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="tca-metric">
                <div class="text-muted small">Average slippage (bps)</div>
                <div class="fs-5 fw-semibold" id="tcaAvgBps">--</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="tca-metric">
                <div class="text-muted small">Average queue (ms)</div>
                <div class="fs-5 fw-semibold" id="tcaAvgQueue">--</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="tca-metric">
                <div class="text-muted small">Current recommendation</div>
                <div class="fs-5 fw-semibold" id="tcaRecommendation">--</div>
              </div>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm" id="tcaHourlyTable">
              <thead>
                <tr>
                  <th>Hour</th>
                  <th>Avg Slippage (bps)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="row g-3 mt-3" id="banditPanel">
        <div class="col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Bandit Ranking</span>
              <span class="text-muted small" id="banditAlgorithm"></span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm" id="banditArmsTable">
                  <thead>
                    <tr>
                      <th>Preset</th>
                      <th>Pulls</th>
                      <th>Reward μ</th>
                      <th>Variance</th>
                      <th>Status</th>
                      <th>Role</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Bandit Recent Pulls</span>
              <span class="text-muted small" id="banditCanaryShare"></span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm" id="banditPullsTable">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Preset</th>
                      <th>Reward</th>
                      <th>PnL R</th>
                      <th>Slip bps</th>
                      <th>Fees bps</th>
                      <th>Decision</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="card shadow-sm mt-3">
        <div class="card-header d-flex justify-content-between">
          <span>Summary</span>
          <div>
            <select id="groupBy" class="form-select form-select-sm d-inline w-auto">
              <option value="day">Daily</option>
              <option value="week">Weekly</option>
              <option value="month">Monthly</option>
              <option value="range">Range</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm" id="exportSummaryCsv">Export CSV</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-hover" id="summaryTable">
              <thead>
                <tr>
                  <th>Label</th>
                  <th>Trades</th>
                  <th>Wins</th>
                  <th>Losses</th>
                  <th>Win%</th>
                  <th>Gross PnL</th>
                  <th>Net PnL</th>
                  <th>Fees</th>
                  <th>Profit Factor</th>
                  <th>Max DD</th>
                  <th>Sharpe</th>
                  <th>Sortino</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/heatmap.js@2.0.5/build/heatmap.min.js"></script>
    <script th:src="@{/js/dashboard.js}" src="/js/dashboard.js"></script>
  </body>
</html>
